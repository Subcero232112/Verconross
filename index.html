<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CosmicWave - Comparte contenido en sincronía</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
      // Import the functions you need from the SDKs you need
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      // **DESCOMENTA Y AÑADE LOS SDKS QUE NECESITAS**
      import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js";

      // Your web app's Firebase configuration
      // For Firebase JS SDK v7.20.0 and later, measurementId is optional
      const firebaseConfig = {
        apiKey: "AIzaSyBoxhLAxA3Lgq_L_ztW8MXvj5zhbhOOyB8", // ¡Usa tu propia API Key!
        authDomain: "ross-9301b.firebaseapp.com",
        projectId: "ross-9301b",
        storageBucket: "ross-9301b.firebasestorage.app",
        messagingSenderId: "120661854127",
        appId: "1:120661854127:web:cbe011f5358a6ef8fa915a",
        measurementId: "G-LJWD2K1EPY" // Opcional
      };

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      // **INICIALIZA LOS SERVICIOS**
      const auth = getAuth(app);
      const db = getFirestore(app);
      const analytics = getAnalytics(app); // Opcional

      // Exporta las instancias para usarlas en tu script principal
      window.firebaseInstances = { auth, db };

    </script>

    <style>
        /* Reset y estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Montserrat', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: #fff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animación de estrellas */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: twinkle 5s infinite;
        }

        @keyframes twinkle {
            0% { opacity: 0.2; }
            50% { opacity: 1; }
            100% { opacity: 0.2; }
        }

        /* Navbar */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background-color: rgba(23, 15, 77, 0.6);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(to right, #7303c0, #ec38bc, #fdeff9);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: flex;
            align-items: center;
        }

        .logo svg {
            margin-right: 10px;
            fill: url(#logo-gradient);
        }

        .nav-links {
            display: flex;
            gap: 2rem;
        }

        .nav-link {
            color: #fff;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-link:after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: -5px;
            left: 0;
            background: linear-gradient(to right, #7303c0, #ec38bc);
            transition: width 0.3s ease;
        }

        .nav-link:hover:after {
            width: 100%;
        }

        /* Auth Buttons & User Info */
        .auth-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .auth-buttons {
            display: flex;
            gap: 1rem;
        }

        .user-info {
            display: none; /* Oculto por defecto */
            align-items: center;
            gap: 0.8rem;
            color: #fff;
            font-weight: 500;
        }

        .user-info img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.5);
        }

        .btn {
            padding: 0.6rem 1.2rem;
            border-radius: 30px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
        }

        .btn-login {
            background-color: transparent;
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .btn-login:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .btn-signup {
            background: linear-gradient(to right, #7303c0, #ec38bc);
            color: #fff;
        }

        .btn-signup:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-logout {
            background-color: rgba(255, 82, 82, 0.7);
            color: #fff;
            border: 1px solid rgba(255, 82, 82, 1);
        }
        .btn-logout:hover {
            background-color: rgba(255, 82, 82, 0.9);
        }

        /* --- ESTILOS RESTANTES (Hero, Features, etc.) --- */
        /* --- (Se omiten para brevedad, son los mismos que proporcionaste) --- */
        .hero { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 5rem 2rem; position: relative; overflow: hidden; }
        .hero-title { font-size: 3.5rem; margin-bottom: 1.5rem; background: linear-gradient(to right, #7303c0, #ec38bc, #fdeff9); -webkit-background-clip: text; background-clip: text; color: transparent; max-width: 800px; }
        .hero-subtitle { font-size: 1.2rem; margin-bottom: 2.5rem; max-width: 600px; line-height: 1.6; color: rgba(255, 255, 255, 0.8); }
        .hero-buttons { display: flex; gap: 1.5rem; margin-bottom: 3rem; }
        .btn-hero { padding: 0.8rem 2.5rem; font-size: 1.1rem; }
        .cosmic-orb { position: absolute; width: 350px; height: 350px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #7303c0, #ec38bc, #302b63); filter: blur(60px); z-index: -1; opacity: 0.6; animation: float 8s infinite ease-in-out; }
        .orb-1 { top: -100px; right: -100px; }
        .orb-2 { bottom: -150px; left: -100px; animation-delay: 2s; }
        @keyframes float { 0% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-20px) rotate(5deg); } 100% { transform: translateY(0) rotate(0deg); } }
        .features { padding: 5rem 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 3rem; max-width: 1200px; margin: 0 auto; }
        .feature-card { background: rgba(23, 15, 77, 0.5); border-radius: 20px; padding: 2rem; transition: transform 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; align-items: center; text-align: center; }
        .feature-card:hover { transform: translateY(-10px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); }
        .feature-icon { width: 80px; height: 80px; background: linear-gradient(135deg, #7303c0, #ec38bc); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 1.5rem; }
        .feature-icon svg { width: 40px; height: 40px; fill: #fff; }
        .feature-title { font-size: 1.5rem; margin-bottom: 1rem; background: linear-gradient(to right, #7303c0, #ec38bc); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .feature-desc { color: rgba(255, 255, 255, 0.8); line-height: 1.6; }
        .app-preview { padding: 5rem 2rem; display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; }
        .preview-title { font-size: 2.5rem; margin-bottom: 1.5rem; background: linear-gradient(to right, #7303c0, #ec38bc, #fdeff9); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .preview-subtitle { font-size: 1.2rem; margin-bottom: 3rem; max-width: 600px; line-height: 1.6; color: rgba(255, 255, 255, 0.8); }
        .preview-image { position: relative; width: 80%; max-width: 1000px; margin-bottom: 3rem; }
        .device-mockup { width: 100%; height: auto; border-radius: 20px; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3); border: 2px solid rgba(255, 255, 255, 0.1); background: rgba(23, 15, 77, 0.3); overflow: hidden; position: relative; }
        .mockup-content { width: 100%; height: 0; padding-bottom: 56.25%; /* 16:9 */ position: relative; overflow: hidden; }
        .mockup-content::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(115, 3, 192, 0.2), rgba(236, 56, 188, 0.2)); z-index: 1; }
        .players-interface { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; }
        .top-controls { display: flex; justify-content: space-between; padding: 15px; background: rgba(0, 0, 0, 0.5); }
        .room-info { display: flex; align-items: center; gap: 10px; }
        .room-name { font-weight: bold; font-size: 1.2rem; }
        .viewer-count { background: rgba(255, 255, 255, 0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.9rem; }
        .control-icons { display: flex; gap: 15px; }
        .content-area { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; position: relative; }
        .media-placeholder { width: 100%; height: 100%; object-fit: cover; background: linear-gradient(135deg, #0f0c29, #302b63, #24243e); }
        .chat-overlay { position: absolute; right: 0; top: 0; width: 25%; height: 100%; background: rgba(0, 0, 0, 0.7); padding: 15px; display: flex; flex-direction: column; }
        .chat-messages { flex: 1; overflow-y: auto; margin-bottom: 15px; }
        .chat-message { margin-bottom: 10px; background: rgba(255, 255, 255, 0.1); padding: 8px 12px; border-radius: 15px; font-size: 0.9rem; }
        .message-author { font-weight: bold; color: #ec38bc; margin-bottom: 3px; }
        .chat-input { display: flex; background: rgba(255, 255, 255, 0.1); border-radius: 30px; padding: 8px; }
        .chat-input input { flex: 1; background: transparent; border: none; color: #fff; padding: 5px 10px; outline: none; }
        .bottom-controls { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(0, 0, 0, 0.5); }
        .media-controls { display: flex; gap: 20px; align-items: center; }
        .progress-bar { flex: 1; height: 5px; background: rgba(255, 255, 255, 0.2); border-radius: 5px; margin: 0 15px; }
        .progress-filled { width: 45%; height: 100%; background: linear-gradient(to right, #7303c0, #ec38bc); border-radius: 5px; }
        .cta { padding: 5rem 2rem; text-align: center; position: relative; }
        .cta-container { background: rgba(23, 15, 77, 0.7); border-radius: 20px; padding: 3rem; max-width: 800px; margin: 0 auto; border: 1px solid rgba(255, 255, 255, 0.1); position: relative; overflow: hidden; }
        .cta-title { font-size: 2.5rem; margin-bottom: 1.5rem; background: linear-gradient(to right, #7303c0, #ec38bc, #fdeff9); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .cta-subtitle { font-size: 1.2rem; margin-bottom: 2.5rem; line-height: 1.6; color: rgba(255, 255, 255, 0.8); }
        .cta-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; opacity: 0.15; }
        .footer { background: rgba(23, 15, 77, 0.8); padding: 3rem 2rem; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .footer-content { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 3rem; }
        .footer-column { display: flex; flex-direction: column; }
        .footer-logo { font-size: 1.5rem; font-weight: 700; background: linear-gradient(to right, #7303c0, #ec38bc, #fdeff9); -webkit-background-clip: text; background-clip: text; color: transparent; margin-bottom: 1rem; }
        .footer-desc { color: rgba(255, 255, 255, 0.6); line-height: 1.6; margin-bottom: 1.5rem; }
        .social-icons { display: flex; gap: 1rem; }
        .social-icon { width: 40px; height: 40px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
        .social-icon:hover { background: linear-gradient(to right, #7303c0, #ec38bc); transform: translateY(-3px); }
        .footer-title { font-size: 1.2rem; font-weight: 600; margin-bottom: 1.5rem; color: #fff; }
        .footer-links { display: flex; flex-direction: column; gap: 0.8rem; }
        .footer-link { color: rgba(255, 255, 255, 0.6); text-decoration: none; transition: all 0.3s ease; }
        .footer-link:hover { color: #ec38bc; transform: translateX(5px); }
        .copyright { text-align: center; padding-top: 3rem; color: rgba(255, 255, 255, 0.5); border-top: 1px solid rgba(255, 255, 255, 0.1); margin-top: 3rem; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.3s ease; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: rgba(23, 15, 77, 0.9); border-radius: 20px; padding: 2rem; width: 90%; max-width: 500px; box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3); transform: translateY(20px); transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.1); position: relative; }
        .modal-overlay.active .modal { transform: translateY(0); }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; color: rgba(255, 255, 255, 0.6); cursor: pointer; transition: all 0.3s ease; }
        .modal-close:hover { color: #ec38bc; }
        .modal-title { font-size: 1.8rem; margin-bottom: 1.5rem; background: linear-gradient(to right, #7303c0, #ec38bc); -webkit-background-clip: text; background-clip: text; color: transparent; text-align: center; }
        .input-group { margin-bottom: 1.5rem; }
        .input-label { display: block; margin-bottom: 0.5rem; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; }
        .input-field { width: 100%; padding: 0.8rem 1rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; color: #fff; font-size: 1rem; transition: all 0.3s ease; }
        .input-field:focus { outline: none; border-color: #ec38bc; background: rgba(255, 255, 255, 0.15); }
        .btn-modal { width: 100%; padding: 0.8rem; margin-top: 1rem; font-size: 1.1rem; }

        /* Modal Auth Styles */
        .auth-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 1.5rem;
        }
        .btn-google {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            background-color: #fff;
            color: #333;
            border: 1px solid #ccc;
        }
        .btn-google:hover {
            background-color: #f5f5f5;
        }
        .btn-google svg {
            width: 20px;
            height: 20px;
        }
        .auth-divider {
            text-align: center;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 1rem;
            position: relative;
        }
        .auth-divider::before, .auth-divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background-color: rgba(255, 255, 255, 0.2);
        }
        .auth-divider::before { left: 0; }
        .auth-divider::after { right: 0; }

        .modal-switch { text-align: center; margin-top: 1.5rem; color: rgba(255, 255, 255, 0.6); font-size: 0.9rem; }
        .modal-switch-link { color: #ec38bc; cursor: pointer; text-decoration: underline; transition: all 0.3s ease; font-weight: 600; }
        .modal-switch-link:hover { color: #fdeff9; }
        .error-message {
             color: #ff6b6b;
             font-size: 0.9rem;
             margin-top: -0.8rem;
             margin-bottom: 1rem;
             text-align: center;
             display: none; /* Oculto por defecto */
         }

        /* Join Room Modal */
        .room-list { max-height: 200px; overflow-y: auto; margin: 1rem 0; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.1); }
        .room-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); cursor: pointer; transition: all 0.3s ease; }
        .room-item:last-child { border-bottom: none; }
        .room-item:hover { background: rgba(255, 255, 255, 0.1); }
        .room-info-modal { display: flex; flex-direction: column; }
        .room-name-modal { font-weight: 600; color: #fff; }
        .room-viewers { font-size: 0.8rem; color: rgba(255, 255, 255, 0.6); }
        .room-join { background: linear-gradient(to right, #7303c0, #ec38bc); color: #fff; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600; border: none; cursor: pointer; transition: all 0.3s ease; }
        .room-join:hover { opacity: 0.9; transform: translateY(-2px); }

        /* Notification */
        .notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: linear-gradient(to right, #7303c0, #ec38bc); color: #fff; padding: 1rem 2rem; border-radius: 10px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3); z-index: 1000; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); }
        .notification.show { bottom: 30px; }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-title { font-size: 2.5rem; }
            .nav-links { display: none; }
            .hero-buttons { flex-direction: column; width: 100%; max-width: 300px; }
            .btn-hero { width: 100%; }
            .preview-image { width: 95%; }
            .chat-overlay { width: 50%; }
        }
        @media (max-width: 480px) {
            .navbar { padding: 1rem; }
            .logo { font-size: 1.5rem; }
            .hero-title { font-size: 2rem; }
            .auth-section { gap: 0.5rem; } /* Ajustar gap para móviles */
            .auth-buttons { gap: 0.5rem; }
            .btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
            .feature-card { padding: 1.5rem; }
            .cta-container { padding: 2rem 1rem; }
            .chat-overlay { width: 100%; height: 30%; bottom: 0; top: auto; }
            .user-info span { display: none; } /* Ocultar nombre en móvil */
        }

        /* Estilos para la creación de sala y Player */
        .create-room-form { display: flex; flex-direction: column; gap: 1.2rem; }
        .room-options { display: flex; flex-direction: column; gap: 0.8rem; }
        .option-group { display: flex; align-items: center; gap: 1rem; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.2); transition: .3s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background: linear-gradient(to right, #7303c0, #ec38bc); }
        input:checked + .slider:before { transform: translateX(26px); }
        .url-input-container { position: relative; margin-top: 1rem; }
        .url-type-selector { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); display: flex; align-items: center; background: rgba(255, 255, 255, 0.1); padding: 5px 10px; border-radius: 5px; color: rgba(255, 255, 255, 0.8); font-size: 0.9rem; pointer-events: none; }
        .media-input { /* Nombre genérico */ width: 100%; padding: 0.8rem 1rem 0.8rem 7rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 10px; color: #fff; font-size: 1rem; }
        .media-input::placeholder { color: rgba(255, 255, 255, 0.5); }

        /* Sala de Reproducción */
        .room-container { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%); z-index: 200; flex-direction: column; }
        .room-container.active { display: flex; }
        .room-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: rgba(23, 15, 77, 0.8); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .room-title { font-size: 1.5rem; font-weight: 600; color: #fff; display: flex; align-items: center; gap: 10px; }
        .room-id { background: rgba(255, 255, 255, 0.1); padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.9rem; font-weight: normal; cursor: pointer; transition: background 0.3s ease; }
        .room-id:hover { background: rgba(255, 255, 255, 0.2); }
        .room-actions { display: flex; gap: 1rem; align-items: center; }
        .btn-invite { /* Renombrado para claridad */ background: linear-gradient(to right, #7303c0, #ec38bc); color: #fff; }
        .btn-leave { background: rgba(255, 0, 0, 0.2); color: #fff; border: 1px solid rgba(255, 0, 0, 0.5); transition: all 0.3s ease; }
        .btn-leave:hover { background: rgba(255, 0, 0, 0.4); }
        .room-content { display: flex; flex: 1; height: calc(100% - 68px); /* Ajustar si el header cambia */ }
        .player-wrapper { /* Nuevo contenedor */ flex: 1; background: #000; position: relative; overflow: hidden; }
        #youtubePlayer { width: 100%; height: 100%; }
        #html5Player { width: 100%; height: 100%; display: none; /* Oculto por defecto */ }
        .chat-container { width: 350px; background: rgba(23, 15, 77, 0.7); border-left: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; }
        .chat-header { padding: 1rem; background: rgba(0, 0, 0, 0.2); border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-weight: 600; text-align: center; }
        .chat-messages-container { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.8rem; }
        .message { background: rgba(255, 255, 255, 0.1); padding: 0.6rem 1rem; border-radius: 10px; animation: fadeIn 0.3s ease; max-width: 90%; word-wrap: break-word; }
        .message.sent { align-self: flex-end; background: linear-gradient(to right, rgba(115, 3, 192, 0.5), rgba(236, 56, 188, 0.5)); }
        .message.received { align-self: flex-start; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message-user { font-size: 0.8rem; font-weight: 600; margin-bottom: 0.3rem; color: #ec38bc; }
        .message.sent .message-user { color: #fdeff9; } /* Distinto color para el remitente */
        .message-text { color: rgba(255, 255, 255, 0.9); line-height: 1.4; font-size: 0.95rem; }
        .chat-input-container { padding: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1); display: flex; gap: 0.5rem; }
        .chat-input-field { flex: 1; padding: 0.7rem 1rem; background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 20px; color: #fff; outline: none; }
        .btn-send { background: linear-gradient(to right, #7303c0, #ec38bc); color: #fff; border: none; border-radius: 20px; padding: 0.5rem 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .btn-send:hover { opacity: 0.9; }
        .btn-send:disabled { opacity: 0.5; cursor: not-allowed; }

        .player-controls { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0, 0, 0, 0.7); padding: 0.8rem 1rem; display: flex; align-items: center; gap: 1rem; transition: opacity 0.3s ease; opacity: 0; pointer-events: none; }
        .player-wrapper:hover .player-controls { opacity: 1; pointer-events: auto; }
        .control-btn { background: transparent; border: none; color: #fff; cursor: pointer; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.2s ease; }
        .control-btn:hover { background: rgba(255, 255, 255, 0.15); }
        .control-btn.active { background: rgba(188, 56, 236, 0.5); } /* Estado activo para mic/cam */
        .control-btn svg { width: 20px; height: 20px; fill: #fff; }
        .control-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .control-btn:disabled:hover { background: transparent; }
        #screenShareBtn { position: relative; }
        #screenShareBtn[disabled]::after { content: "Próximamente"; position: absolute; bottom: -25px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 2px 5px; border-radius: 4px; font-size: 0.7rem; white-space: nowrap; display: none; /* Ocultar por defecto */ }
        #screenShareBtn[disabled]:hover::after { display: block; } /* Mostrar al hacer hover */

        .timeline { flex: 1; height: 5px; background: rgba(255, 255, 255, 0.3); border-radius: 3px; position: relative; cursor: pointer; margin: 0 10px; }
        .timeline-progress { position: absolute; top: 0; left: 0; height: 100%; background: linear-gradient(to right, #7303c0, #ec38bc); border-radius: 3px; width: 0%; pointer-events: none; }
        .timeline-handle { position: absolute; top: 50%; left: 0%; transform: translate(-50%, -50%); width: 12px; height: 12px; background: #fff; border-radius: 50%; box-shadow: 0 0 5px rgba(0, 0, 0, 0.5); pointer-events: none; opacity: 0; transition: opacity 0.2s ease; }
        .timeline:hover .timeline-handle { opacity: 1; }
        .volume-control { display: flex; align-items: center; gap: 0.5rem; width: 120px; }
        .volume-slider { flex: 1; height: 4px; background: rgba(255, 255, 255, 0.3); border-radius: 2px; position: relative; cursor: pointer; }
        .volume-level { position: absolute; top: 0; left: 0; height: 100%; background: linear-gradient(to right, #7303c0, #ec38bc); border-radius: 2px; width: 70%; pointer-events: none; }
        .time-display { font-size: 0.9rem; color: rgba(255, 255, 255, 0.9); width: 100px; text-align: center; }

        /* Modal para crear sala */
        .modal-tabs { display: flex; margin-bottom: 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .modal-tab { flex: 1; padding: 0.8rem; text-align: center; color: rgba(255, 255, 255, 0.6); cursor: pointer; transition: all 0.3s ease; position: relative; font-weight: 500; }
        .modal-tab.active { color: #fff; font-weight: 600;}
        .modal-tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: linear-gradient(to right, #7303c0, #ec38bc); }
        .modal-tab-content { display: none; }
        .modal-tab-content.active { display: block; }
        .modal-tab[disabled] { opacity: 0.5; cursor: not-allowed; }
        .modal-tab[disabled]:hover::after { background: none; } /* No mostrar línea en hover si está deshabilitado */

        /* Responsive for room interface */
        @media (max-width: 900px) {
            .chat-container { width: 300px; }
        }
        @media (max-width: 768px) {
            .room-content { flex-direction: column; height: calc(100% - 60px); /* Header height */ }
            .player-wrapper { height: calc(65% - 1px); /* Ajustar porcentaje + borde */ } /* Ajustar según necesidad */
            .chat-container { width: 100%; height: 35%; border-left: none; border-top: 1px solid rgba(255, 255, 255, 0.1); }
            .player-controls { padding: 0.5rem; gap: 0.5rem; }
            .control-btn { width: 30px; height: 30px; }
            .control-btn svg { width: 18px; height: 18px; }
            .volume-control { width: 100px; }
            .time-display { width: 90px; font-size: 0.8rem; }
        }
        @media (max-width: 480px) {
            .room-header { padding: 0.8rem 1rem; flex-direction: column; align-items: flex-start; gap: 0.5rem; height: auto; } /* Ajustar header */
            .room-content { height: calc(100% - 85px); /* Ajustar según nuevo header */ }
            .room-actions { width: 100%; justify-content: space-between; margin-top: 5px; }
            .chat-container { height: 40%; }
            .player-wrapper { height: 60%; }
            .player-controls { padding: 0.5rem; gap: 0.3rem; }
            .volume-control { display: none; } /* Ocultar volumen en pantallas muy pequeñas */
            .time-display { width: 80px; }
        }

    </style>
</head>
<body>
    <div class="stars" id="stars"></div>

    <nav class="navbar">
        <div class="logo">
            <svg width="24" height="24" viewBox="0 0 24 24">
                <defs>
                    <linearGradient id="logo-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#7303c0" />
                        <stop offset="100%" stop-color="#ec38bc" />
                    </linearGradient>
                </defs>
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/>
            </svg>
            CosmicWave
        </div>
        <div class="nav-links">
            <a href="#features" class="nav-link">Características</a>
            <a href="#preview" class="nav-link">Vista Previa</a>
            </div>
        <div class="auth-section">
            <div class="auth-buttons" id="authButtons">
                <button class="btn btn-login" id="loginBtn">Iniciar Sesión</button>
                <button class="btn btn-signup" id="signupBtn">Registrarse</button>
            </div>
             <div class="user-info" id="userInfo">
                 <img id="userAvatar" src="https://i.imgur.com/8Km9tLL.png" alt="Avatar">
                 <span id="userName">Usuario</span>
                 <button class="btn btn-logout" id="logoutBtn">Salir</button>
             </div>
        </div>
    </nav>

    <section class="hero">
        <div class="cosmic-orb orb-1"></div>
        <div class="cosmic-orb orb-2"></div>
        <h1 class="hero-title">Ve videos y escucha música en sincronía con amigos</h1>
        <p class="hero-subtitle">CosmicWave te permite disfrutar de contenido multimedia junto a tus amigos en tiempo real, sin importar dónde se encuentren. Mira películas, series o videos y chatea con ellos en un ambiente cósmico y único.</p>
        <div class="hero-buttons">
            <button class="btn btn-signup btn-hero" id="createRoomBtn">Crear Sala</button>
            <button class="btn btn-login btn-hero" id="joinRoomBtn">Unirse a Sala</button>
        </div>
    </section>

    <section class="features" id="features">
        <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><path d="M21 3H3c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H3V5h18v14zM8 15c0-1.66 1.34-3 3-3 .35 0 .69.07 1 .18V6h5v2h-3v7.03c-.02 1.64-1.35 2.97-3 2.97-1.66 0-3-1.34-3-3z"/></svg></div>
            <h3 class="feature-title">Sincronización Perfecta</h3>
            <p class="feature-desc">Disfruta de películas, videos y música perfectamente sincronizados con todos los participantes, sin desfases ni retrasos.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z"/></svg></div>
            <h3 class="feature-title">Chat en Vivo</h3>
            <p class="feature-desc">Comenta cada momento con un chat interactivo y reacciona en tiempo real a lo que estás viendo con tus amigos.</p>
        </div>
        <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg></div>
            <h3 class="feature-title">Múltiples Fuentes</h3>
            <p class="feature-desc">Comparte contenido desde YouTube, Google Drive y más, todo en un solo lugar.</p>
        </div>
    </section>

    <section class="app-preview" id="preview">
         <h2 class="preview-title">Una Experiencia Cósmica</h2>
         <p class="preview-subtitle">Interfaz intuitiva y elegante diseñada para que disfrutes al máximo tus momentos compartidos con amigos y familiares.</p>
         <div class="preview-image">
             <div class="device-mockup">
                 <div class="mockup-content">
                    </div>
             </div>
         </div>
    </section>

    <section class="cta">
        <div class="cta-container">
            <div class="cta-bg"></div>
            <h2 class="cta-title">¿Listo para la experiencia cósmica?</h2>
            <p class="cta-subtitle">Regístrate ahora y comienza a compartir momentos inolvidables con tus amigos desde cualquier lugar del universo.</p>
            <button class="btn btn-signup btn-hero" id="ctaSignupBtn">Empieza Ahora</button>
        </div>
    </section>

    <footer class="footer">
         <div class="copyright">
              © 2024 CosmicWave. Todos los derechos reservados. </div>
     </footer>

    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <div class="modal-close" id="closeAuthModal">×</div>
            <div id="authModalContent">
                </div>
        </div>
    </div>

    <div class="modal-overlay" id="createRoomModal">
        <div class="modal">
            <div class="modal-close" id="closeCreateRoomModal">×</div>
            <h2 class="modal-title">Crear Nueva Sala</h2>
            <div class="create-room-form">
                <div class="input-group">
                    <label class="input-label" for="roomNameInput">Nombre de la Sala</label>
                    <input type="text" class="input-field" id="roomNameInput" placeholder="Mi sala de cine cósmica">
                </div>
                <div class="room-options">
                    <div class="option-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="privateRoomToggle">
                            <span class="slider"></span>
                        </label>
                        <span>Sala Privada (Próximamente)</span>
                    </div>
                    <div class="option-group">
                        <label class="toggle-switch">
                            <input type="checkbox" id="onlyHostControlsToggle">
                            <span class="slider"></span>
                        </label>
                        <span>Solo anfitrión controla reproducción</span>
                    </div>
                </div>
                <div class="modal-tabs">
                    <div class="modal-tab active" data-tab="youtube">YouTube</div>
                    <div class="modal-tab" data-tab="drive">Google Drive</div>
                    <div class="modal-tab" data-tab="screen" disabled>Pantalla</div>
                </div>
                <div class="modal-tab-content active" id="youtube-tab">
                    <div class="url-input-container">
                        <div class="url-type-selector">YouTube</div>
                        <input type="text" class="media-input" id="youtubeUrlInput" placeholder="Pega un enlace de YouTube">
                    </div>
                </div>
                <div class="modal-tab-content" id="drive-tab">
                     <div class="url-input-container">
                         <div class="url-type-selector">Drive</div>
                         <input type="text" class="media-input" id="driveUrlInput" placeholder="Pega enlace directo de Google Drive">
                     </div>
                     <p style="font-size: 0.8rem; color: rgba(255,255,255,0.5); margin-top: 5px;">Nota: Requiere enlace directo al video.</p>
                </div>
                <div class="modal-tab-content" id="screen-tab">
                    <p style="text-align: center; color: rgba(255,255,255,0.7);">Compartir pantalla estará disponible pronto.</p>
                </div>
                 <p class="error-message" id="createRoomError"></p>
                <button class="btn btn-signup btn-modal" id="createRoomConfirmBtn">Crear Sala</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="joinRoomModal">
        <div class="modal">
            <div class="modal-close" id="closeJoinRoomModal">×</div>
            <h2 class="modal-title">Unirse a Sala</h2>
            <div class="input-group">
                <label class="input-label" for="roomCodeInput">Código de la sala</label>
                <input type="text" class="input-field" id="roomCodeInput" placeholder="Ingresa el código" maxlength="6">
            </div>
            <p class="error-message" id="joinRoomError"></p>
            <button class="btn btn-signup btn-modal" id="joinRoomConfirmBtn">Unirse</button>
        </div>
    </div>

    <div class="room-container" id="roomContainer">
        <div class="room-header">
            <div class="room-title">
                <span id="currentRoomName">Cargando...</span>
                <span class="room-id" id="roomIdDisplay" title="Copiar ID de Sala">ID: ------</span>
            </div>
            <div class="room-actions">
                <button class="btn btn-invite" id="inviteBtn">Invitar (Copiar ID)</button>
                <button class="btn btn-leave" id="leaveRoomBtn">Salir de la Sala</button>
            </div>
        </div>
        <div class="room-content">
            <div class="player-wrapper" id="playerWrapper">
                <div id="youtubePlayer"></div>
                <video id="html5Player" controlslist="nodownload noremoteplayback" disablepictureinpicture></video>

                <div class="player-controls" id="playerControls">
                    <button class="control-btn" id="playPauseBtn" title="Reproducir/Pausar">
                        <svg viewBox="0 0 24 24">
                            <path d="M8 5v14l11-7L8 5z"/> </svg>
                    </button>
                     <div class="time-display" id="timeDisplay">0:00 / 0:00</div>
                    <div class="timeline" id="videoTimeline" title="Buscar en video">
                        <div class="timeline-progress" id="timelineProgress"></div>
                        <div class="timeline-handle" id="timelineHandle"></div>
                    </div>
                    <div class="volume-control">
                        <button class="control-btn" id="muteBtn" title="Silenciar/Activar Sonido">
                            <svg viewBox="0 0 24 24" id="muteIcon"> <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>
                            </svg>
                        </button>
                        <div class="volume-slider" id="volumeSlider" title="Control de Volumen">
                            <div class="volume-level" id="volumeLevel"></div>
                        </div>
                    </div>
                    <button class="control-btn" id="micBtn" title="Activar/Desactivar Micrófono (Próximamente)">
                         <svg viewBox="0 0 24 24">
                             <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/>
                         </svg>
                    </button>
                    <button class="control-btn" id="cameraBtn" title="Activar/Desactivar Cámara (Próximamente)">
                         <svg viewBox="0 0 24 24">
                             <path d="M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4zM14 13h-3v3H9v-3H6v-2h3V8h2v3h3v2z"/>
                         </svg>
                    </button>
                    <button class="control-btn" id="screenShareBtn" disabled title="Compartir Pantalla (Próximamente)">
                         <svg viewBox="0 0 24 24">
                             <path d="M20 18c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2H1c-.55 0-1 .45-1 1s.45 1 1 1h22c.55 0 1-.45 1-1s-.45-1-1-1h-3zm-7-3.53v-2.19c-2.78 0-4.61.85-6 2.72.56-2.67 2.11-5.33 6-5.87V7l4 3.73-4 3.74z"/>
                         </svg>
                    </button>
                     <button class="control-btn" id="fullscreenBtn" title="Pantalla Completa">
                         <svg viewBox="0 0 24 24">
                            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="chat-container">
                <div class="chat-header">Chat de la Sala</div>
                <div class="chat-messages-container" id="chatMessages">
                    <div class="message received">
                         <div class="message-user">Sistema</div>
                         <div class="message-text">¡Bienvenido! Los mensajes aparecerán aquí.</div>
                     </div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input-field" id="chatInput" placeholder="Escribe tu mensaje..." maxlength="500">
                    <button class="btn-send" id="sendMessageBtn" disabled>Enviar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="notificationContainer" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 2000;"></div>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script type="module">
        // Importar funciones de Firebase Auth y Firestore
        import {
            GoogleAuthProvider,
            signInWithPopup,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            setDoc,
            getDoc,
            onSnapshot,
            collection,
            addDoc,
            query,
            orderBy,
            limit,
            serverTimestamp,
            Timestamp,
            updateDoc,
            deleteDoc // Opcional si quieres borrar salas
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Obtener instancias de Firebase (exportadas desde el script de inicialización)
        const { auth, db } = window.firebaseInstances;

        // --- VARIABLES GLOBALES ---
        let currentUser = null;
        let currentRoomId = null;
        let currentRoomData = null;
        let hostControlsOnly = false; // Si el host es el único que controla
        let unsubscribeRoom = null; // Para detener listener de sala
        let unsubscribeChat = null; // Para detener listener de chat

        // Player related
        let ytPlayer;
        let html5Player = document.getElementById('html5Player');
        let playerReady = { youtube: false, html5: false };
        let activePlayerType = null; // 'youtube' or 'html5'
        let isSeeking = false; // Flag para evitar bucles al buscar
        let localUpdateSource = false; // Flag para saber si la actualización vino del usuario local
        let lastSentState = null; // Para evitar enviar estados redundantes

        // UI Elements
        const authModal = document.getElementById('authModal');
        const authModalContent = document.getElementById('authModalContent');
        const closeAuthModalBtn = document.getElementById('closeAuthModal');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const ctaSignupBtn = document.getElementById('ctaSignupBtn');
        const authButtonsContainer = document.getElementById('authButtons');
        const userInfoContainer = document.getElementById('userInfo');
        const userNameDisplay = document.getElementById('userName');
        const userAvatarDisplay = document.getElementById('userAvatar');
        const logoutBtn = document.getElementById('logoutBtn');

        const createRoomBtn = document.getElementById('createRoomBtn');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const createRoomModal = document.getElementById('createRoomModal');
        const closeCreateRoomModal = document.getElementById('closeCreateRoomModal');
        const createRoomConfirmBtn = document.getElementById('createRoomConfirmBtn');
        const createRoomErrorMsg = document.getElementById('createRoomError');

        const joinRoomModal = document.getElementById('joinRoomModal');
        const closeJoinRoomModal = document.getElementById('closeJoinRoomModal');
        const joinRoomConfirmBtn = document.getElementById('joinRoomConfirmBtn');
        const roomCodeInput = document.getElementById('roomCodeInput');
        const joinRoomErrorMsg = document.getElementById('joinRoomError');

        const roomContainer = document.getElementById('roomContainer');
        const leaveRoomBtn = document.getElementById('leaveRoomBtn');
        const currentRoomNameDisplay = document.getElementById('currentRoomName');
        const roomIdDisplay = document.getElementById('roomIdDisplay');
        const inviteBtn = document.getElementById('inviteBtn');

        const playerWrapper = document.getElementById('playerWrapper');
        const youtubePlayerContainer = document.getElementById('youtubePlayer');
        const playerControls = document.getElementById('playerControls');
        const playPauseBtn = document.getElementById('playPauseBtn');
        const videoTimeline = document.getElementById('videoTimeline');
        const timelineProgress = document.getElementById('timelineProgress');
        const timelineHandle = document.getElementById('timelineHandle');
        const timeDisplay = document.getElementById('timeDisplay');
        const muteBtn = document.getElementById('muteBtn');
        const muteIcon = document.getElementById('muteIcon'); // El SVG dentro del botón mute
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeLevel = document.getElementById('volumeLevel');
        const fullscreenBtn = document.getElementById('fullscreenBtn');

        const micBtn = document.getElementById('micBtn');
        const cameraBtn = document.getElementById('cameraBtn');

        const chatMessagesContainer = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendMessageBtn = document.getElementById('sendMessageBtn');

        // --- AUTENTICACIÓN ---

        // Escuchar cambios de estado de autenticación
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = {
                    uid: user.uid,
                    displayName: user.displayName || "Usuario Anónimo", // Usar nombre de Google o genérico
                    photoURL: user.photoURL || 'https://i.imgur.com/8Km9tLL.png' // Usar foto de Google o genérica
                };
                console.log("Usuario conectado:", currentUser);
                updateUIBasedOnAuthState(true);
                sendMessageBtn.disabled = false; // Habilitar chat al iniciar sesión
                 // Si estaba en un modal, ciérralo
                 if (authModal.classList.contains('active')) {
                     authModal.classList.remove('active');
                 }
            } else {
                currentUser = null;
                console.log("Usuario desconectado.");
                updateUIBasedOnAuthState(false);
                sendMessageBtn.disabled = true; // Deshabilitar chat si no está logueado
                // Si el usuario está en una sala y se desconecta, sacarlo
                if (roomContainer.classList.contains('active')) {
                    leaveRoom();
                    showNotification("Debes iniciar sesión para permanecer en la sala.", "error");
                }
            }
        });

        function updateUIBasedOnAuthState(isLoggedIn) {
            if (isLoggedIn) {
                authButtonsContainer.style.display = 'none';
                userInfoContainer.style.display = 'flex';
                userNameDisplay.textContent = currentUser.displayName.split(' ')[0]; // Mostrar solo primer nombre
                userAvatarDisplay.src = currentUser.photoURL;
            } else {
                authButtonsContainer.style.display = 'flex';
                userInfoContainer.style.display = 'none';
            }
             // Habilitar/Deshabilitar botones de crear/unirse a sala
             createRoomBtn.disabled = !isLoggedIn;
             joinRoomBtn.disabled = !isLoggedIn;
             if (!isLoggedIn) {
                createRoomBtn.title = "Inicia sesión para crear una sala";
                joinRoomBtn.title = "Inicia sesión para unirte a una sala";
             } else {
                 createRoomBtn.title = "";
                 joinRoomBtn.title = "";
             }
        }

        // Mostrar Modal de Autenticación (Login o Signup)
        function showAuthModal(type = 'login') {
             let htmlContent = `
                 <h2 class="modal-title">${type === 'login' ? 'Iniciar Sesión' : 'Regístrate'}</h2>
                 <div class="auth-options">
                     <button class="btn btn-google" id="googleSignInBtn">
                         <svg viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path><path fill="none" d="M0 0h48v48H0z"></path></svg>
                         ${type === 'login' ? 'Iniciar con Google' : 'Registrarse con Google'}
                     </button>
                 </div>
                 <div class="auth-divider">O</div>
                 <div class="input-group">
                     <label class="input-label" for="emailInput">Correo Electrónico</label>
                     <input type="email" class="input-field" id="emailInput" placeholder="tu@correo.com">
                 </div>
                 <div class="input-group">
                     <label class="input-label" for="passwordInput">Contraseña</label>
                     <input type="password" class="input-field" id="passwordInput" placeholder="••••••••">
                 </div>
                 ${type === 'signup' ? `
                 <div class="input-group">
                     <label class="input-label" for="confirmPasswordInput">Confirmar Contraseña</label>
                     <input type="password" class="input-field" id="confirmPasswordInput" placeholder="••••••••">
                 </div>` : ''}
                 <p class="error-message" id="authError"></p>
                 <button class="btn btn-signup btn-modal" id="emailAuthBtn">${type === 'login' ? 'Iniciar Sesión' : 'Registrarse'}</button>
                 <div class="modal-switch">
                     ${type === 'login'
                         ? '¿No tienes cuenta? <span class="modal-switch-link" data-switch-to="signup">Regístrate</span>'
                         : '¿Ya tienes cuenta? <span class="modal-switch-link" data-switch-to="login">Inicia Sesión</span>'}
                 </div>
             `;
             authModalContent.innerHTML = htmlContent;

             // Añadir event listeners a los nuevos botones
             document.getElementById('googleSignInBtn').addEventListener('click', signInWithGoogle);
             document.getElementById('emailAuthBtn').addEventListener('click', () => {
                 if (type === 'login') handleEmailLogin();
                 else handleEmailSignup();
             });
             document.querySelectorAll('.modal-switch-link').forEach(link => {
                 link.addEventListener('click', (e) => {
                     showAuthModal(e.target.dataset.switchTo);
                 });
             });

             authModal.classList.add('active');
         }

        // --- Funciones de Autenticación Firebase ---

        const googleProvider = new GoogleAuthProvider();
        async function signInWithGoogle() {
            try {
                const result = await signInWithPopup(auth, googleProvider);
                console.log("Inicio de sesión con Google exitoso", result.user);
                showNotification(`¡Bienvenido, ${result.user.displayName.split(' ')[0]}!`);
                // onAuthStateChanged se encargará de cerrar el modal y actualizar UI
            } catch (error) {
                console.error("Error en inicio de sesión con Google:", error);
                 displayAuthError("Error al iniciar sesión con Google. Inténtalo de nuevo.");
            }
        }

        async function handleEmailLogin() {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const errorMsgElement = document.getElementById('authError');
            errorMsgElement.style.display = 'none'; // Ocultar errores previos

            if (!email || !password) {
                 displayAuthError("Por favor, ingresa correo y contraseña.");
                return;
            }

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("Inicio de sesión con correo exitoso", userCredential.user);
                 showNotification(`¡Bienvenido de nuevo!`);
                 // onAuthStateChanged se encargará de cerrar el modal y actualizar UI
            } catch (error) {
                console.error("Error en inicio de sesión con correo:", error);
                let friendlyMessage = "Error al iniciar sesión.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    friendlyMessage = "Correo o contraseña incorrectos.";
                } else if (error.code === 'auth/invalid-email') {
                    friendlyMessage = "El formato del correo no es válido.";
                }
                 displayAuthError(friendlyMessage);
            }
        }

        async function handleEmailSignup() {
             const email = document.getElementById('emailInput').value;
             const password = document.getElementById('passwordInput').value;
             const confirmPassword = document.getElementById('confirmPasswordInput').value;
             const errorMsgElement = document.getElementById('authError');
             errorMsgElement.style.display = 'none'; // Ocultar errores previos

             if (!email || !password || !confirmPassword) {
                 displayAuthError("Por favor, completa todos los campos.");
                 return;
             }
             if (password !== confirmPassword) {
                 displayAuthError("Las contraseñas no coinciden.");
                 return;
             }
             if (password.length < 6) {
                 displayAuthError("La contraseña debe tener al menos 6 caracteres.");
                 return;
             }

             try {
                 const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                 console.log("Registro con correo exitoso", userCredential.user);
                 // Puedes pedir nombre de usuario aquí o usar uno genérico
                 showNotification("¡Registro exitoso! Bienvenido.");
                 // onAuthStateChanged se encargará de cerrar el modal y actualizar UI
             } catch (error) {
                 console.error("Error en registro con correo:", error);
                  let friendlyMessage = "Error al registrar la cuenta.";
                  if (error.code === 'auth/email-already-in-use') {
                     friendlyMessage = "Este correo electrónico ya está registrado.";
                  } else if (error.code === 'auth/weak-password') {
                     friendlyMessage = "La contraseña es demasiado débil.";
                  } else if (error.code === 'auth/invalid-email') {
                      friendlyMessage = "El formato del correo no es válido.";
                  }
                 displayAuthError(friendlyMessage);
             }
         }

        async function handleLogout() {
             try {
                 await signOut(auth);
                 console.log("Cierre de sesión exitoso.");
                 showNotification("Has cerrado sesión.");
                 // onAuthStateChanged actualizará la UI
                 // Si está en una sala, leaveRoom() ya se habrá llamado desde onAuthStateChanged
             } catch (error) {
                 console.error("Error al cerrar sesión:", error);
                 showNotification("Error al cerrar sesión.", "error");
             }
         }

        // Helper para mostrar errores en el modal de auth
        function displayAuthError(message) {
            const errorMsgElement = document.getElementById('authError');
            if (errorMsgElement) {
                errorMsgElement.textContent = message;
                errorMsgElement.style.display = 'block';
            }
        }

        // --- MANEJO DE SALAS (FIRESTORE) ---

        async function createRoom() {
            if (!currentUser) {
                showNotification("Debes iniciar sesión para crear una sala.", "error");
                 showAuthModal('login'); // Abrir modal de login
                return;
            }

            const roomName = document.getElementById('roomNameInput').value.trim() || 'Sala Cósmica';
            const isPrivate = document.getElementById('privateRoomToggle').checked; // Funcionalidad futura
            hostControlsOnly = document.getElementById('onlyHostControlsToggle').checked; // Usar esta variable globalmente en la sala
            const activeTab = document.querySelector('.modal-tab.active').dataset.tab;
            let videoUrl, videoId, videoType;
            createRoomErrorMsg.style.display = 'none'; // Resetear error

            if (activeTab === 'youtube') {
                videoUrl = document.getElementById('youtubeUrlInput').value.trim();
                videoId = extractYouTubeID(videoUrl);
                videoType = 'youtube';
                if (!videoId) {
                    createRoomErrorMsg.textContent = 'URL de YouTube inválida.';
                    createRoomErrorMsg.style.display = 'block';
                    return;
                }
            } else if (activeTab === 'drive') {
                videoUrl = document.getElementById('driveUrlInput').value.trim();
                 // Validación básica (podría mejorarse)
                 if (!videoUrl || !videoUrl.toLowerCase().includes('drive.google.com')) {
                     createRoomErrorMsg.textContent = 'URL de Google Drive inválida.';
                     createRoomErrorMsg.style.display = 'block';
                     return;
                 }
                videoId = videoUrl; // Usamos la URL completa como ID por ahora
                videoType = 'html5'; // Usaremos el player HTML5
            } else {
                createRoomErrorMsg.textContent = 'Selecciona una fuente de video válida.';
                createRoomErrorMsg.style.display = 'block';
                return;
            }

            // Generar ID de sala único (6 caracteres alfanuméricos)
            const newRoomId = Math.random().toString(36).substring(2, 8).toUpperCase();

            const roomData = {
                roomId: newRoomId,
                name: roomName,
                creatorUid: currentUser.uid,
                creatorName: currentUser.displayName,
                videoType: videoType,
                videoId: videoId,
                isPrivate: isPrivate, // Para futuro
                hostControlsOnly: hostControlsOnly,
                currentState: 'paused', // Iniciar pausado
                currentTime: 0,
                lastUpdateBy: currentUser.uid,
                createdAt: serverTimestamp() // Timestamp de creación
            };

            try {
                const roomRef = doc(db, "rooms", newRoomId);
                await setDoc(roomRef, roomData);
                console.log("Sala creada con ID:", newRoomId);
                createRoomModal.classList.remove('active');
                // Resetear campos del modal
                 document.getElementById('roomNameInput').value = '';
                 document.getElementById('youtubeUrlInput').value = '';
                 document.getElementById('driveUrlInput').value = '';
                 document.getElementById('privateRoomToggle').checked = false;
                 document.getElementById('onlyHostControlsToggle').checked = false;

                // Entrar a la sala recién creada
                enterRoom(newRoomId);

            } catch (error) {
                console.error("Error al crear sala en Firestore:", error);
                createRoomErrorMsg.textContent = 'Error al crear la sala. Inténtalo de nuevo.';
                createRoomErrorMsg.style.display = 'block';
            }
        }

        async function joinRoom() {
             if (!currentUser) {
                 showNotification("Debes iniciar sesión para unirte a una sala.", "error");
                 showAuthModal('login');
                 return;
             }
            const roomIdToJoin = roomCodeInput.value.trim().toUpperCase();
             joinRoomErrorMsg.style.display = 'none'; // Resetear error

             if (!roomIdToJoin || roomIdToJoin.length !== 6) {
                 joinRoomErrorMsg.textContent = 'Código de sala inválido (debe tener 6 caracteres).';
                 joinRoomErrorMsg.style.display = 'block';
                 return;
             }

             try {
                 const roomRef = doc(db, "rooms", roomIdToJoin);
                 const roomSnap = await getDoc(roomRef);

                 if (roomSnap.exists()) {
                     console.log("Sala encontrada:", roomIdToJoin);
                     // Aquí podrías verificar si es privada y si el usuario tiene acceso (futuro)
                     joinRoomModal.classList.remove('active');
                     roomCodeInput.value = ''; // Limpiar input
                     enterRoom(roomIdToJoin);
                 } else {
                     console.log("Sala no encontrada:", roomIdToJoin);
                     joinRoomErrorMsg.textContent = 'Sala no encontrada. Verifica el código.';
                     joinRoomErrorMsg.style.display = 'block';
                 }
             } catch (error) {
                 console.error("Error al buscar sala:", error);
                 joinRoomErrorMsg.textContent = 'Error al buscar la sala. Inténtalo de nuevo.';
                 joinRoomErrorMsg.style.display = 'block';
             }
         }

        function enterRoom(roomId) {
            if (!currentUser) return; // No debería pasar, pero por seguridad
            currentRoomId = roomId;
            console.log(`Entrando a la sala: ${currentRoomId}`);

            // Mostrar UI de la sala
            roomContainer.classList.add('active');
            currentRoomNameDisplay.textContent = 'Cargando...';
            roomIdDisplay.textContent = `ID: ${currentRoomId}`;
            chatMessagesContainer.innerHTML = ''; // Limpiar chat anterior
            sendMessageBtn.disabled = false; // Habilitar input de chat
            resetPlayerState(); // Reiniciar estado visual del player

            // Suscribirse a cambios de la sala
            const roomRef = doc(db, "rooms", currentRoomId);
            unsubscribeRoom = onSnapshot(roomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const previousRoomData = currentRoomData; // Guardar datos anteriores
                    currentRoomData = docSnap.data();
                    console.log("Datos de la sala actualizados:", currentRoomData);
                    currentRoomNameDisplay.textContent = currentRoomData.name;
                    hostControlsOnly = currentRoomData.hostControlsOnly; // Actualizar estado de control

                    // Cargar o actualizar video si cambió
                    if (!previousRoomData || previousRoomData.videoId !== currentRoomData.videoId || previousRoomData.videoType !== currentRoomData.videoType) {
                        loadVideo(currentRoomData.videoType, currentRoomData.videoId);
                    } else {
                         // Solo sincronizar si el video es el mismo
                         syncPlayerState(currentRoomData);
                    }

                    // Habilitar/deshabilitar controles según hostControlsOnly
                    updatePlayerControlsAccess();

                } else {
                    // La sala fue borrada o no existe
                    console.warn(`La sala ${currentRoomId} ya no existe.`);
                    leaveRoom();
                    showNotification("La sala a la que estabas conectado ya no existe.", "error");
                }
            }, (error) => {
                console.error(`Error al escuchar cambios en la sala ${currentRoomId}:`, error);
                leaveRoom();
                showNotification("Error de conexión con la sala.", "error");
            });

            // Suscribirse a mensajes del chat
            const chatRef = collection(db, "rooms", currentRoomId, "messages");
            const q = query(chatRef, orderBy("timestamp", "asc"), limit(100)); // Limitar mensajes
            unsubscribeChat = onSnapshot(q, (querySnapshot) => {
                // chatMessagesContainer.innerHTML = ''; // Limpiar antes de redibujar (menos eficiente)
                querySnapshot.docChanges().forEach((change) => {
                     if (change.type === "added") {
                         const messageData = change.doc.data();
                         displayChatMessage(messageData);
                     }
                     // Podrías manejar "modified" o "removed" si fuera necesario
                 });
                // Scroll al final solo si estamos cerca del final
                 scrollToBottomIfNear(chatMessagesContainer);
            }, (error) => {
                console.error(`Error al escuchar chat de la sala ${currentRoomId}:`, error);
                // No necesariamente sacar de la sala, pero informar
                displaySystemMessage("Error al cargar mensajes del chat.");
            });
        }

        function leaveRoom() {
             console.log(`Saliendo de la sala: ${currentRoomId}`);
             roomContainer.classList.remove('active');

             // Detener listeners de Firebase
             if (unsubscribeRoom) {
                 unsubscribeRoom();
                 unsubscribeRoom = null;
             }
             if (unsubscribeChat) {
                 unsubscribeChat();
                 unsubscribeChat = null;
             }

             // Detener y limpiar reproductores
             if (ytPlayer && typeof ytPlayer.destroy === 'function') {
                 ytPlayer.destroy();
                 ytPlayer = null;
             }
              html5Player.pause();
              html5Player.removeAttribute('src'); // Limpiar fuente
              html5Player.load(); // Resetear estado
              html5Player.style.display = 'none';
              youtubePlayerContainer.style.display = 'block'; // Volver a mostrar YT por defecto
              playerReady = { youtube: false, html5: false };
              activePlayerType = null;

             // Limpiar variables de estado
             currentRoomId = null;
             currentRoomData = null;
             hostControlsOnly = false;
             chatMessagesContainer.innerHTML = ''; // Limpiar chat visualmente
             sendMessageBtn.disabled = true; // Deshabilitar chat
             resetPlayerState();
         }

        // --- SINCRONIZACIÓN DEL REPRODUCTOR ---

         function loadVideo(type, id) {
             console.log(`Cargando video: Tipo=${type}, ID=${id}`);
             activePlayerType = type;
             resetPlayerState(); // Reiniciar controles visuales antes de cargar

             // Ocultar ambos players inicialmente
             youtubePlayerContainer.style.display = 'none';
             html5Player.style.display = 'none';
             playerReady.youtube = false;
             playerReady.html5 = false;


             if (type === 'youtube') {
                 youtubePlayerContainer.style.display = 'block';
                 if (ytPlayer && typeof ytPlayer.loadVideoById === 'function') {
                     // Si el player ya existe, solo carga el nuevo video
                      playerReady.youtube = false; // Marcar como no listo hasta que onReady se dispare
                     ytPlayer.loadVideoById(id);
                      // No podemos llamar a syncPlayerState aquí, debe esperar a onPlayerReady
                 } else {
                     // Si no existe, crea uno nuevo
                     initYouTubePlayer(id);
                 }
             } else if (type === 'html5') {
                 html5Player.style.display = 'block';
                 html5Player.src = id; // Asume que 'id' es la URL directa
                 html5Player.load(); // Carga la nueva fuente
                 // syncPlayerState se llamará desde el listener onSnapshot cuando los datos estén listos
                 // HTML5 'canplay' event indicará cuándo está listo
             }
         }

        function syncPlayerState(roomData) {
             if (!activePlayerType || !roomData) return;
            // Evitar actuar sobre nuestra propia actualización reciente
             if (localUpdateSource && roomData.lastUpdateBy === currentUser?.uid) {
                 console.log("Sincronización: Ignorando actualización local reciente.");
                 return;
             }

             console.log("Sincronizando estado del player:", roomData.currentState, "@", roomData.currentTime);
             const targetTime = roomData.currentTime || 0;
             const targetState = roomData.currentState || 'paused';

             if (activePlayerType === 'youtube' && playerReady.youtube) {
                 // Sincronizar tiempo (con tolerancia)
                 const currentTime = ytPlayer.getCurrentTime() || 0;
                 if (Math.abs(currentTime - targetTime) > 2.0) { // Tolerancia de 2 segundos
                     console.log(`YT Sync: Seeking to ${targetTime} (current: ${currentTime})`);
                     ytPlayer.seekTo(targetTime, true);
                 }

                 // Sincronizar estado (play/pause)
                 const currentState = ytPlayer.getPlayerState();
                 if (targetState === 'playing' && currentState !== YT.PlayerState.PLAYING) {
                     console.log("YT Sync: Playing video");
                     ytPlayer.playVideo();
                 } else if (targetState === 'paused' && currentState !== YT.PlayerState.PAUSED) {
                      console.log("YT Sync: Pausing video");
                     ytPlayer.pauseVideo();
                 }
                 // Actualizar UI (puede que onStateChange no se dispare si el estado ya era el correcto)
                 updatePlayPauseButton(targetState === 'playing');

             } else if (activePlayerType === 'html5' && playerReady.html5) {
                 // Sincronizar tiempo (con tolerancia)
                 if (!html5Player.seeking && Math.abs(html5Player.currentTime - targetTime) > 2.0) {
                      console.log(`HTML5 Sync: Seeking to ${targetTime} (current: ${html5Player.currentTime})`);
                     html5Player.currentTime = targetTime;
                 }

                 // Sincronizar estado (play/pause)
                  if (targetState === 'playing' && html5Player.paused) {
                     console.log("HTML5 Sync: Playing video");
                     html5Player.play().catch(e => console.warn("Error al auto-play HTML5:", e)); // El navegador puede bloquear autoplay
                 } else if (targetState === 'paused' && !html5Player.paused) {
                     console.log("HTML5 Sync: Pausing video");
                     html5Player.pause();
                 }
                 // Actualizar UI
                  updatePlayPauseButton(targetState === 'playing');
             }
         }

        // Función para enviar actualizaciones de estado a Firestore
        async function sendPlayerStateUpdate(newState) {
            if (!currentRoomId || !currentUser || !currentRoomData) return;

             // Verificar permisos de control
            if (hostControlsOnly && currentRoomData.creatorUid !== currentUser.uid) {
                console.log("Actualización bloqueada: Solo el host puede controlar.");
                // Revertir acción local si es posible (ej. si se intentó pausar, volver a play)
                // Esto es complejo, por ahora solo bloqueamos el envío
                return;
            }

             // Evitar envíos redundantes
            const stateKey = `${newState.currentState}-${Math.round(newState.currentTime ?? 0)}`;
            if (stateKey === lastSentState) {
                 // console.log("Actualización redundante omitida:", stateKey);
                 return;
            }


            const roomRef = doc(db, "rooms", currentRoomId);
            const updateData = {
                lastUpdateBy: currentUser.uid // Quién hizo el último cambio
            };

            if (newState.currentState !== undefined) {
                updateData.currentState = newState.currentState;
            }
            if (newState.currentTime !== undefined) {
                // Redondear a 2 decimales para evitar updates constantes por micro-diferencias
                 updateData.currentTime = Math.round(newState.currentTime * 100) / 100;
            }
            // Añadir timestamp solo si hay cambios reales de estado/tiempo
             if (newState.currentState !== undefined || newState.currentTime !== undefined) {
                updateData.updatedAt = serverTimestamp(); // Marcar cuándo se actualizó
             }


            console.log("Enviando actualización a Firestore:", updateData);
            localUpdateSource = true; // Marcar que esta actualización es local
            lastSentState = stateKey; // Guardar el estado enviado

            try {
                await updateDoc(roomRef, updateData);
                 console.log("Estado actualizado en Firestore");
                 // Resetear el flag después de un breve retraso para permitir que Firestore propague
                 setTimeout(() => { localUpdateSource = false; }, 500); // Ajustar delay si es necesario
            } catch (error) {
                console.error("Error al actualizar estado en Firestore:", error);
                 localUpdateSource = false; // Resetear flag en caso de error
                showNotification("Error al sincronizar.", "error");
            }
        }

        // --- YOUTUBE PLAYER API ---

        // Esta función es llamada automáticamente por la API de YouTube
        window.onYouTubeIframeAPIReady = function() {
            console.log("YouTube IFrame API Ready");
            // No inicializamos el player aquí, lo hacemos cuando se entra a una sala
        }

        function initYouTubePlayer(videoId) {
             // Destruir player anterior si existe
             if (ytPlayer && typeof ytPlayer.destroy === 'function') {
                 ytPlayer.destroy();
                 ytPlayer = null;
             }
             playerReady.youtube = false; // Marcar como no listo

            console.log("Iniciando YT Player con video ID:", videoId);
             ytPlayer = new YT.Player('youtubePlayer', {
                // height y width se heredan del CSS del div#youtubePlayer
                videoId: videoId,
                playerVars: {
                    'playsinline': 1, // Necesario para móviles
                    'autoplay': 0, // NO auto reproducir al cargar, esperar sincronización
                    'controls': 0, // Usaremos nuestros propios controles
                    'rel': 0, // No mostrar videos relacionados
                    'modestbranding': 1, // Menos branding de YT
                    'disablekb': 1 // Deshabilitar controles de teclado por defecto
                },
                events: {
                    'onReady': onYouTubePlayerReady,
                    'onStateChange': onYouTubePlayerStateChange,
                    'onError': onYouTubePlayerError
                }
            });
        }

        function onYouTubePlayerReady(event) {
            console.log("YT Player Listo");
            playerReady.youtube = true;
            activePlayerType = 'youtube'; // Confirmar tipo activo
             // Sincronizar estado inicial DESPUÉS de que el player esté listo
             if (currentRoomData) {
                 syncPlayerState(currentRoomData);
                 updatePlayerControlsAccess(); // Asegurarse de que los controles estén bien configurados
                  // Inicializar volumen/mute visualmente
                  updateVolumeUI(ytPlayer.isMuted() ? 0 : ytPlayer.getVolume());
             }
             // Iniciar actualización periódica de la línea de tiempo
             startTimelineUpdater();
        }

        function onYouTubePlayerStateChange(event) {
             console.log("YT Player State Change:", event.data);
             if (!playerReady.youtube || localUpdateSource) {
                  // Si el cambio fue causado por una actualización local, no hacer nada
                 // O si el player aún no está listo (a veces onStateChange se dispara antes de onReady)
                 return;
             }

             let newState;
             let syncTime = true; // Por defecto, sincronizar tiempo

             switch (event.data) {
                 case YT.PlayerState.PLAYING:
                     newState = 'playing';
                     startTimelineUpdater(); // Asegurarse que el updater corra
                     break;
                 case YT.PlayerState.PAUSED:
                     newState = 'paused';
                     stopTimelineUpdater(); // Detener updater si pausamos manualmente
                     break;
                 case YT.PlayerState.ENDED:
                     newState = 'paused'; // Tratar como pausado al final
                      syncTime = false; // No sincronizar tiempo si terminó
                     stopTimelineUpdater();
                     break;
                 case YT.PlayerState.BUFFERING:
                     // No enviar estado de buffering, puede ser muy frecuente
                     stopTimelineUpdater(); // Detener updater mientras bufferea
                     return; // No enviar update a Firestore por buffering
                 case YT.PlayerState.CUED:
                     newState = 'paused'; // Video cargado pero no iniciado
                     syncTime = false;
                     stopTimelineUpdater();
                     break;
                 default:
                     return; // Estado desconocido o no relevante
             }

             // Actualizar UI del botón Play/Pause inmediatamente
             updatePlayPauseButton(newState === 'playing');


             // Enviar actualización a Firestore si el estado cambió y no fue una actualización local
             if (newState) {
                  const updatePayload = { currentState: newState };
                  if (syncTime && ytPlayer && typeof ytPlayer.getCurrentTime === 'function') {
                    updatePayload.currentTime = ytPlayer.getCurrentTime();
                  }
                 sendPlayerStateUpdate(updatePayload);
             }
         }

         function onYouTubePlayerError(event) {
             console.error("Error en YT Player:", event.data);
             let errorMsg = "Error desconocido del reproductor de YouTube.";
             switch (event.data) {
                 case 2: errorMsg = "Solicitud inválida (ID de video incorrecto?)."; break;
                 case 5: errorMsg = "Error del reproductor HTML5."; break;
                 case 100: errorMsg = "Video no encontrado o marcado como privado."; break;
                 case 101: case 150: errorMsg = "El propietario no permite la reproducción embebida."; break;
             }
             showNotification(errorMsg, "error");
             displaySystemMessage(errorMsg); // También en el chat
             // Podríamos intentar cargar un video placeholder o mostrar un mensaje en el player
         }

        // --- HTML5 PLAYER API ---

        html5Player.addEventListener('loadedmetadata', () => {
            console.log("HTML5 Player Metadata Loaded");
             // playerReady.html5 se pondrá en true con 'canplay'
            updateTimelineUI(0, html5Player.duration); // Actualizar duración total
             startTimelineUpdater(); // Iniciar updater
        });

        html5Player.addEventListener('canplay', () => {
             console.log("HTML5 Player Can Play");
             playerReady.html5 = true;
             activePlayerType = 'html5';
             if (currentRoomData) {
                 syncPlayerState(currentRoomData); // Sincronizar estado inicial
                 updatePlayerControlsAccess();
                  // Inicializar volumen/mute visualmente
                  updateVolumeUI(html5Player.muted ? 0 : html5Player.volume * 100);
             }
        });

         html5Player.addEventListener('play', () => {
             console.log("HTML5 Player Play event");
             if (!playerReady.html5 || localUpdateSource) return;
              updatePlayPauseButton(true);
             sendPlayerStateUpdate({ currentState: 'playing', currentTime: html5Player.currentTime });
             startTimelineUpdater();
         });

         html5Player.addEventListener('pause', () => {
             console.log("HTML5 Player Pause event");
              // Ignorar pause si es porque terminó el video o si fue local
             if (!playerReady.html5 || localUpdateSource || html5Player.ended) return;
              updatePlayPauseButton(false);
             sendPlayerStateUpdate({ currentState: 'paused', currentTime: html5Player.currentTime });
             stopTimelineUpdater();
         });

        html5Player.addEventListener('ended', () => {
             console.log("HTML5 Player Ended event");
             if (!playerReady.html5 || localUpdateSource) return;
              updatePlayPauseButton(false); // Mostrar como pausado
             // Enviar estado pausado, pero SIN actualizar el tiempo (dejarlo al final)
             sendPlayerStateUpdate({ currentState: 'paused' });
             stopTimelineUpdater();
         });

         html5Player.addEventListener('seeking', () => {
             console.log("HTML5 Player Seeking event");
             isSeeking = true; // Marcar que estamos buscando
              stopTimelineUpdater(); // Pausar updater mientras buscamos
         });

         html5Player.addEventListener('seeked', () => {
             console.log("HTML5 Player Seeked event");
             isSeeking = false;
             if (!playerReady.html5 || !localUpdateSource) return; // Solo enviar si fue un seek local
             // Enviar el nuevo tiempo y el estado ACTUAL (podría estar pausado o play)
             sendPlayerStateUpdate({
                 currentState: html5Player.paused ? 'paused' : 'playing',
                 currentTime: html5Player.currentTime
             });
             startTimelineUpdater(); // Reanudar updater
         });

         html5Player.addEventListener('timeupdate', () => {
             if (!playerReady.html5 || isSeeking) return; // No actualizar mientras se busca
             updateTimelineUI(html5Player.currentTime, html5Player.duration);
         });

         html5Player.addEventListener('volumechange', () => {
             if (!playerReady.html5 || localUpdateSource) return;
             // Actualizar UI de volumen (no sincronizamos volumen entre usuarios por ahora)
              updateVolumeUI(html5Player.muted ? 0 : html5Player.volume * 100);
         });

         html5Player.addEventListener('error', (e) => {
             console.error("Error en HTML5 Player:", e);
             let errorMsg = "Error al cargar el video.";
             const error = html5Player.error;
             if (error) {
                 switch (error.code) {
                     case error.MEDIA_ERR_ABORTED: errorMsg = "Carga de video abortada."; break;
                     case error.MEDIA_ERR_NETWORK: errorMsg = "Error de red al cargar video."; break;
                     case error.MEDIA_ERR_DECODE: errorMsg = "Error al decodificar el video."; break;
                     case error.MEDIA_ERR_SRC_NOT_SUPPORTED: errorMsg = "Formato de video no soportado o enlace inválido."; break;
                 }
             }
             showNotification(errorMsg, "error");
             displaySystemMessage(errorMsg);
         });


        // --- CONTROLES DEL REPRODUCTOR (Comunes) ---

        let timelineUpdaterInterval = null;

        function startTimelineUpdater() {
            stopTimelineUpdater(); // Limpiar intervalo anterior
            timelineUpdaterInterval = setInterval(() => {
                if (activePlayerType === 'youtube' && playerReady.youtube && ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
                    updateTimelineUI(ytPlayer.getCurrentTime(), ytPlayer.getDuration());
                } else if (activePlayerType === 'html5' && playerReady.html5 && !html5Player.paused && !isSeeking) {
                     updateTimelineUI(html5Player.currentTime, html5Player.duration);
                }
            }, 500); // Actualizar cada 500ms
        }

        function stopTimelineUpdater() {
            if (timelineUpdaterInterval) {
                clearInterval(timelineUpdaterInterval);
                timelineUpdaterInterval = null;
            }
        }

        function updateTimelineUI(current, duration) {
             if (!isNaN(current) && !isNaN(duration) && duration > 0) {
                 const progress = (current / duration) * 100;
                 timelineProgress.style.width = `${progress}%`;
                 timelineHandle.style.left = `${progress}%`;
                 timeDisplay.textContent = `${formatTime(current)} / ${formatTime(duration)}`;
             } else {
                  // Estado inicial o inválido
                 timelineProgress.style.width = '0%';
                 timelineHandle.style.left = '0%';
                 timeDisplay.textContent = `0:00 / ${formatTime(duration || 0)}`;
             }
         }

        function resetPlayerState() {
             updateTimelineUI(0, 0);
             updatePlayPauseButton(false); // Mostrar icono Play
             // Podríamos resetear volumen también si quisiéramos
             stopTimelineUpdater(); // Detener actualizaciones
             // Deshabilitar controles hasta que el player esté listo
             playerControls.querySelectorAll('button, .timeline, .volume-slider').forEach(el => el.disabled = true);
         }

        function updatePlayerControlsAccess() {
             const canControl = !hostControlsOnly || (currentUser && currentRoomData && currentUser.uid === currentRoomData.creatorUid);
             const playerIsReady = (activePlayerType === 'youtube' && playerReady.youtube) || (activePlayerType === 'html5' && playerReady.html5);

             console.log(`Actualizando acceso a controles: Puede controlar=${canControl}, Player Listo=${playerIsReady}`);

            // Habilitar/deshabilitar según si el player está listo Y si tiene permiso
             const shouldEnable = playerIsReady && canControl;

             playPauseBtn.disabled = !shouldEnable;
             videoTimeline.style.pointerEvents = shouldEnable ? 'auto' : 'none'; // Permitir click en timeline
             playPauseBtn.title = shouldEnable ? "Reproducir/Pausar" : (playerIsReady ? "Solo el host controla" : "Cargando...");
             videoTimeline.title = shouldEnable ? "Buscar en video" : (playerIsReady ? "Solo el host controla" : "Cargando...");

             // Controles de volumen y pantalla completa siempre habilitados si el player está listo
             const secondaryControlsEnabled = playerIsReady;
             muteBtn.disabled = !secondaryControlsEnabled;
             volumeSlider.style.pointerEvents = secondaryControlsEnabled ? 'auto' : 'none';
             fullscreenBtn.disabled = !secondaryControlsEnabled;

             // Mensaje de "Solo host controla" (opcional)
             // const controlMessage = document.getElementById('controlMessage');
             // if (controlMessage) {
             //     controlMessage.style.display = (hostControlsOnly && !canControl) ? 'block' : 'none';
             // }
         }

        function updatePlayPauseButton(isPlaying) {
            if (isPlaying) {
                playPauseBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>`; // Icono Pausa
                playPauseBtn.title = "Pausar";
            } else {
                playPauseBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7L8 5z"/></svg>`; // Icono Play
                playPauseBtn.title = "Reproducir";
            }
        }

        function togglePlayPause() {
             if (!activePlayerType || !currentUser) return;

             let isPlaying = false;
             let currentTime = 0;

            // Verificar permiso antes de actuar
             if (hostControlsOnly && currentRoomData?.creatorUid !== currentUser.uid) {
                 showNotification("Solo el host puede controlar la reproducción.", "warning");
                 return;
             }

             if (activePlayerType === 'youtube' && playerReady.youtube) {
                 const state = ytPlayer.getPlayerState();
                 if (state === YT.PlayerState.PLAYING) {
                     ytPlayer.pauseVideo();
                     isPlaying = false;
                 } else {
                     ytPlayer.playVideo();
                     isPlaying = true;
                 }
                 currentTime = ytPlayer.getCurrentTime();
             } else if (activePlayerType === 'html5' && playerReady.html5) {
                 if (html5Player.paused || html5Player.ended) {
                     html5Player.play().catch(e => console.warn("Error al play HTML5:", e));
                     isPlaying = true;
                 } else {
                     html5Player.pause();
                     isPlaying = false;
                 }
                 currentTime = html5Player.currentTime;
             }

             // Actualizar UI inmediatamente
             updatePlayPauseButton(isPlaying);

             // Enviar actualización a Firestore
             sendPlayerStateUpdate({ currentState: isPlaying ? 'playing' : 'paused', currentTime: currentTime });
         }

        function handleTimelineSeek(event) {
             if (!activePlayerType || !currentUser) return;

             // Verificar permiso antes de actuar
              if (hostControlsOnly && currentRoomData?.creatorUid !== currentUser.uid) {
                  showNotification("Solo el host puede controlar la reproducción.", "warning");
                  return;
              }

             const timelineRect = videoTimeline.getBoundingClientRect();
             const clickPosition = event.clientX - timelineRect.left;
             const totalWidth = timelineRect.width;
             const seekRatio = Math.max(0, Math.min(1, clickPosition / totalWidth)); // Clamp between 0 and 1

             let seekTime = 0;
             let duration = 0;
             let currentState = 'paused'; // Estado por defecto al buscar

             if (activePlayerType === 'youtube' && playerReady.youtube) {
                 duration = ytPlayer.getDuration();
                 seekTime = seekRatio * duration;
                 console.log(`YT Seek request: ${seekTime}`);
                 ytPlayer.seekTo(seekTime, true);
                 // El estado se enviará en onStateChange o en el seeked simulado
                 currentState = ytPlayer.getPlayerState() === YT.PlayerState.PLAYING ? 'playing' : 'paused';
             } else if (activePlayerType === 'html5' && playerReady.html5) {
                 duration = html5Player.duration;
                  if (isNaN(duration) || duration <= 0) return; // No buscar si no hay duración
                 seekTime = seekRatio * duration;
                 console.log(`HTML5 Seek request: ${seekTime}`);
                 html5Player.currentTime = seekTime;
                 // El estado se enviará en el evento 'seeked'
                 currentState = html5Player.paused ? 'paused' : 'playing';
             }

             // Actualizar UI inmediatamente
             updateTimelineUI(seekTime, duration);

             // Enviar actualización a Firestore (el evento seeked/onStateChange también lo hará, pero esto da feedback más rápido)
             // Marcamos como local para que el listener de 'seeked' no reenvíe
             localUpdateSource = true;
             sendPlayerStateUpdate({ currentState: currentState, currentTime: seekTime });
             // No reseteamos localUpdateSource aquí, lo hará el evento 'seeked' o el timeout de sendPlayerStateUpdate
         }

        function toggleMute() {
             if (!activePlayerType) return;
             let isMutedNow = false;
             let currentVolume = 100; // Volumen por defecto si se desmutea

            if (activePlayerType === 'youtube' && playerReady.youtube) {
                if (ytPlayer.isMuted()) {
                    ytPlayer.unMute();
                    isMutedNow = false;
                    currentVolume = ytPlayer.getVolume();
                } else {
                    ytPlayer.mute();
                    isMutedNow = true;
                }
            } else if (activePlayerType === 'html5' && playerReady.html5) {
                 if (html5Player.muted) {
                     html5Player.muted = false;
                     isMutedNow = false;
                     currentVolume = html5Player.volume * 100;
                 } else {
                     html5Player.muted = true;
                     isMutedNow = true;
                 }
            }
             // Actualizar UI de volumen
             updateVolumeUI(isMutedNow ? 0 : currentVolume, isMutedNow);
        }

        function handleVolumeChange(event) {
             if (!activePlayerType) return;

             const sliderRect = volumeSlider.getBoundingClientRect();
             const clickPosition = event.clientX - sliderRect.left;
             const totalWidth = sliderRect.width;
             const volumeRatio = Math.max(0, Math.min(1, clickPosition / totalWidth));
             const volumePercent = Math.round(volumeRatio * 100);

             if (activePlayerType === 'youtube' && playerReady.youtube) {
                 ytPlayer.setVolume(volumePercent);
                 if (ytPlayer.isMuted() && volumePercent > 0) {
                     ytPlayer.unMute(); // Desmutear si se sube el volumen
                 } else if (!ytPlayer.isMuted() && volumePercent === 0) {
                     ytPlayer.mute(); // Mutear si se baja a 0
                 }
             } else if (activePlayerType === 'html5' && playerReady.html5) {
                 html5Player.volume = volumeRatio;
                  if (html5Player.muted && volumeRatio > 0) {
                      html5Player.muted = false;
                  } else if (!html5Player.muted && volumeRatio === 0) {
                       html5Player.muted = true;
                  }
             }

             // Actualizar UI de volumen
             updateVolumeUI(volumePercent, volumePercent === 0);
         }

         // Actualiza la barra de volumen y el icono de mute
         function updateVolumeUI(volumePercent, isMutedOverride = undefined) {
            const isActuallyMuted = (isMutedOverride !== undefined) ? isMutedOverride : (volumePercent === 0);
             volumeLevel.style.width = `${isActuallyMuted ? 0 : volumePercent}%`; // Barra a 0 si está muteado

             // Cambiar icono de mute
             if (isActuallyMuted) {
                 muteIcon.innerHTML = `<path d="M16.5 12c0-1.77-1.02-3.29-2.5-4.03v2.21l2.45 2.45c.03-.2.05-.41.05-.63zm2.5 0c0 .94-.2 1.82-.54 2.64l1.51 1.51C20.63 14.91 21 13.5 21 12c0-4.28-2.99-7.86-7-8.77v2.06c2.89.86 5 3.54 5 6.71zM4.27 3L3 4.27 7.73 9H3v6h4l5 5v-6.73l4.25 4.25c-.67.52-1.42.93-2.25 1.18v2.06c1.38-.31 2.63-.95 3.69-1.81L19.73 21 21 19.73l-9-9L4.27 3zM12 4L9.91 6.09 12 8.18V4z"/>`; // Icono Mute
                 muteBtn.title = "Activar Sonido";
             } else {
                 muteIcon.innerHTML = `<path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/>`; // Icono Volumen
                 muteBtn.title = "Silenciar";
             }
         }

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                // Entrar a pantalla completa (intentar con el wrapper del player)
                 playerWrapper.requestFullscreen().catch(err => {
                    console.error(`Error al entrar en pantalla completa: ${err.message} (${err.name})`);
                    // Fallback: intentar con el body si el wrapper falla
                    // document.body.requestFullscreen();
                });
            } else {
                // Salir de pantalla completa
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }


        // --- CHAT (FIRESTORE) ---

        async function sendMessage() {
             if (!currentUser || !currentRoomId) {
                 showNotification("No se puede enviar mensaje. No estás conectado o en una sala.", "error");
                 return;
             }
             const messageText = chatInput.value.trim();
             if (!messageText) {
                 return; // No enviar mensajes vacíos
             }

             // Deshabilitar temporalmente mientras se envía
             chatInput.disabled = true;
             sendMessageBtn.disabled = true;

             const messageData = {
                 userId: currentUser.uid,
                 userName: currentUser.displayName || "Usuario Anónimo",
                 // userAvatar: currentUser.photoURL || 'https://i.imgur.com/8Km9tLL.png', // Opcional: guardar avatar
                 text: messageText,
                 timestamp: serverTimestamp() // Usar timestamp del servidor
             };

             try {
                 const chatRef = collection(db, "rooms", currentRoomId, "messages");
                 await addDoc(chatRef, messageData);
                 console.log("Mensaje enviado:", messageText);
                 chatInput.value = ''; // Limpiar input
             } catch (error) {
                 console.error("Error al enviar mensaje:", error);
                 showNotification("Error al enviar el mensaje.", "error");
             } finally {
                 // Rehabilitar input y botón
                 chatInput.disabled = false;
                 sendMessageBtn.disabled = false;
                 chatInput.focus(); // Poner foco de nuevo en el input
             }
         }

         function displayChatMessage(messageData) {
             if (!messageData || !messageData.text) return; // Ignorar mensajes inválidos

             const messageEl = document.createElement('div');
             messageEl.classList.add('message');

             // Determinar si el mensaje es del usuario actual
             const isSent = messageData.userId === currentUser?.uid;
             messageEl.classList.add(isSent ? 'sent' : 'received');

             // Usar un nombre por defecto si no existe
             const displayName = messageData.userName || 'Usuario';

             messageEl.innerHTML = `
                 <div class="message-user">${displayName}</div>
                 <div class="message-text">${escapeHTML(messageData.text)}</div>
             `;
             chatMessagesContainer.appendChild(messageEl);

            // Scroll al final solo si estamos cerca del final
            scrollToBottomIfNear(chatMessagesContainer);
         }

        // Muestra un mensaje del sistema en el chat (ej. errores, bienvenidas)
        function displaySystemMessage(text) {
             const messageEl = document.createElement('div');
             messageEl.classList.add('message', 'received'); // Estilo como recibido
             messageEl.style.opacity = '0.8'; // Un poco más tenue
             messageEl.innerHTML = `
                 <div class="message-user" style="color: #aaa;">Sistema</div>
                 <div class="message-text" style="font-style: italic;">${escapeHTML(text)}</div>
             `;
             chatMessagesContainer.appendChild(messageEl);
             scrollToBottomIfNear(chatMessagesContainer);
        }

        // Hace scroll hacia abajo en un elemento solo si ya está cerca del final
         function scrollToBottomIfNear(element, threshold = 50) {
             const isScrolledToBottom = element.scrollHeight - element.clientHeight <= element.scrollTop + threshold;
             if (isScrolledToBottom) {
                 element.scrollTop = element.scrollHeight;
             }
         }

        // --- UTILIDADES ---

        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) {
                return "0:00";
            }
            seconds = Math.floor(seconds);
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds < 10 ? '0' : ''}${remainingSeconds}`;
        }

        // Extrae ID de video de varias URLs de YouTube
        function extractYouTubeID(url) {
            if (!url) return false;
            // Expresión regular mejorada para manejar varios formatos de URL
            const regExp = /^(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|\S*?[?&]v=)|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
            const match = url.match(regExp);
            console.log("URL:", url, "Match:", match);
            return (match && match[1]) ? match[1] : false;
        }

        // Función simple para escapar HTML y prevenir XSS básico en el chat
        function escapeHTML(str) {
             const div = document.createElement('div');
             div.appendChild(document.createTextNode(str));
             return div.innerHTML;
         }

        // Función para mostrar notificaciones temporales
         function showNotification(message, type = 'success') {
             const container = document.getElementById('notificationContainer');
             const notification = document.createElement('div');
             notification.className = `notification ${type}`; // Usa la clase .notification y añade success/error/warning
             notification.textContent = message;

             // Añadir estilos específicos por tipo si no los tienes en CSS
             if (type === 'error') {
                 notification.style.background = 'linear-gradient(to right, #e53935, #c62828)'; // Rojo
             } else if (type === 'warning') {
                  notification.style.background = 'linear-gradient(to right, #ffb300, #ffa000)'; // Naranja/Amarillo
             } // El estilo por defecto es el gradiente morado/rosa

             container.appendChild(notification);

             // Forzar reflow para que la animación funcione
             notification.offsetHeight;

             notification.classList.add('show');

             setTimeout(() => {
                 notification.classList.remove('show');
                 // Esperar que termine la transición de salida antes de remover
                 notification.addEventListener('transitionend', () => {
                     if (notification.parentNode === container) {
                         container.removeChild(notification);
                     }
                 });
             }, 3000); // Duración de la notificación
         }

        // Copiar ID de sala al portapapeles
        function copyRoomIdToClipboard() {
            if (!currentRoomId) return;
            navigator.clipboard.writeText(currentRoomId)
                .then(() => {
                    showNotification(`ID de Sala ${currentRoomId} copiado!`);
                })
                .catch(err => {
                    console.error('Error al copiar ID de sala: ', err);
                    showNotification('No se pudo copiar el ID.', 'error');
                    // Fallback manual si falla la API (raro en navegadores modernos)
                    // prompt("Copia manualmente el ID de la sala:", currentRoomId);
                });
        }


        // --- INICIALIZACIÓN Y EVENT LISTENERS GLOBALES ---

        // Event listeners para abrir/cerrar modales
         loginBtn.addEventListener('click', () => showAuthModal('login'));
         signupBtn.addEventListener('click', () => showAuthModal('signup'));
         ctaSignupBtn.addEventListener('click', () => showAuthModal('signup')); // Botón CTA también abre signup
         closeAuthModalBtn.addEventListener('click', () => authModal.classList.remove('active'));

         createRoomBtn.addEventListener('click', () => {
              if (!currentUser) {
                 showNotification("Inicia sesión para crear una sala", "warning");
                 showAuthModal('login');
             } else {
                createRoomModal.classList.add('active');
             }
         });
         closeCreateRoomModal.addEventListener('click', () => createRoomModal.classList.remove('active'));
         createRoomConfirmBtn.addEventListener('click', createRoom);

         joinRoomBtn.addEventListener('click', () => {
              if (!currentUser) {
                 showNotification("Inicia sesión para unirte a una sala", "warning");
                 showAuthModal('login');
             } else {
                 joinRoomModal.classList.add('active');
                 roomCodeInput.focus(); // Poner foco en el input
             }
         });
         closeJoinRoomModal.addEventListener('click', () => joinRoomModal.classList.remove('active'));
         joinRoomConfirmBtn.addEventListener('click', joinRoom);
         // Permitir unirse presionando Enter en el input del código
         roomCodeInput.addEventListener('keypress', (e) => {
             if (e.key === 'Enter') {
                 joinRoomConfirmBtn.click();
             }
         });

         // Listener para Logout
         logoutBtn.addEventListener('click', handleLogout);

        // Listener para salir de la sala
        leaveRoomBtn.addEventListener('click', leaveRoom);

        // Listener para copiar ID de sala
        inviteBtn.addEventListener('click', copyRoomIdToClipboard);
        roomIdDisplay.addEventListener('click', copyRoomIdToClipboard); // También al hacer clic en el ID

        // Listeners para controles del reproductor
         playPauseBtn.addEventListener('click', togglePlayPause);
         videoTimeline.addEventListener('click', handleTimelineSeek);
         muteBtn.addEventListener('click', toggleMute);
         volumeSlider.addEventListener('click', handleVolumeChange);
         fullscreenBtn.addEventListener('click', toggleFullScreen);

        // Listeners para chat
        sendMessageBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { // Enviar con Enter (Shift+Enter para nueva línea)
                e.preventDefault(); // Prevenir nueva línea por defecto
                sendMessageBtn.click();
            }
        });

        // Listeners para Mic/Cam (solo visual por ahora)
         micBtn.addEventListener('click', () => {
             micBtn.classList.toggle('active');
             showNotification(`Micrófono ${micBtn.classList.contains('active') ? 'activado' : 'desactivado'} (Funcionalidad Próximamente)`, 'warning');
         });
         cameraBtn.addEventListener('click', () => {
             cameraBtn.classList.toggle('active');
             showNotification(`Cámara ${cameraBtn.classList.contains('active') ? 'activada' : 'desactivada'} (Funcionalidad Próximamente)`, 'warning');
         });

        // Listeners para pestañas del modal Crear Sala
         document.querySelectorAll('.modal-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                if (tab.hasAttribute('disabled')) return;

                const targetTabId = tab.dataset.tab;
                // Ocultar todos los contenidos
                document.querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));
                // Quitar clase activa de todas las pestañas
                document.querySelectorAll('.modal-tab').forEach(t => t.classList.remove('active'));

                // Mostrar contenido y marcar pestaña activa
                document.getElementById(`${targetTabId}-tab`).classList.add('active');
                tab.classList.add('active');

                 // Actualizar el selector de tipo de URL visualmente
                 const selector = document.querySelector(`#${targetTabId}-tab .url-type-selector`);
                 if (selector) {
                     // No es necesario cambiar el texto, ya está fijo por pestaña
                 }
                 // Limpiar mensajes de error al cambiar de pestaña
                  createRoomErrorMsg.style.display = 'none';
            });
        });


        // Crear estrellas iniciales
        function createStars() {
            const starsContainer = document.getElementById('stars');
            if (!starsContainer) return; // Salir si no existe el contenedor
             // Limpiar estrellas existentes si se llama de nuevo
             starsContainer.innerHTML = '';
            const starsCount = 150;
            for (let i = 0; i < starsCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.width = `${Math.random() * 2 + 0.5}px`; // Estrellas entre 0.5 y 2.5px
                star.style.height = star.style.width;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                // Asegurar que la animación tenga una duración y delay variables
                 star.style.animationDuration = `${Math.random() * 4 + 3}s`; // Duración entre 3s y 7s
                star.style.animationDelay = `${Math.random() * 5}s`;
                starsContainer.appendChild(star);
            }
        }
        createStars(); // Llamar a la función al cargar el script

        // Inicializar estado de la UI basado en si hay usuario o no (al cargar la página)
         updateUIBasedOnAuthState(auth.currentUser != null);

    </script>
    <script type="module" src="main.js"></script>
</body>
</html>
